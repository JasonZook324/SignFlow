@page "{id:guid}"
@model ProposalViewModel
@attribute [Microsoft.AspNetCore.Authorization.Authorize]
@{
    ViewData["Title"] = "Proposal";
}
<h2>@Model.Proposal?.Title</h2>
@if (Model.Proposal != null)
{
    <p>Status: <strong>@Model.Proposal.Status</strong></p>
    <form method="post" asp-page-handler="Send" class="mb-3">
        <button class="btn btn-sm btn-primary" type="submit" @(Model.Proposal.Status == SignFlow.Domain.Entities.ProposalStatus.Signed ? "" : null)>Send Signing Link</button>
        @if (Model.SigningLink != null)
        {
            <span class="ms-2">Link: <a href="@Model.SigningLink" target="_blank">@Model.SigningLink</a></span>
        }
        <a asp-page="Delete" asp-route-id="@Model.Proposal.Id" class="btn btn-sm btn-danger ms-2" asp-authorize asp-policy="OrgOwner">Delete</a>
    </form>
    @if (Model.Proposal.Status == SignFlow.Domain.Entities.ProposalStatus.Signed && (Model.LatestPayment == null || Model.LatestPayment.Status != SignFlow.Domain.Entities.PaymentStatus.Succeeded))
    {
        <p><a class="btn btn-success btn-sm" asp-page="Pay" asp-route-id="@Model.Proposal.Id">Pay Now</a></p>
    }
    @if (Model.LatestPayment?.Status == SignFlow.Domain.Entities.PaymentStatus.Succeeded)
    {
        <div class="alert alert-success p-2">Payment succeeded @Model.LatestPayment.PaidUtc?.ToLocalTime() @if(Model.LatestPayment.ReceiptUrl!=null){<span>- <a href="@Model.LatestPayment.ReceiptUrl" target="_blank">Receipt</a></span>}</div>
    }
    <div class="row g-4">
        <div class="col-md-8">
            <table class="table table-sm">
                <thead><tr><th>Description</th><th>Qty</th><th>Unit</th><th>Line</th></tr></thead>
                <tbody>
                @foreach (var item in Model.Items)
                {
                    <tr>
                        <td>@item.Description</td>
                        <td>@item.Quantity</td>
                        <td>@item.UnitPrice.ToString("C")</td>
                        <td>@(item.Quantity * item.UnitPrice).ToString("C")</td>
                    </tr>
                }
                </tbody>
            </table>
            <div class="mt-3">
                <div>Subtotal: @Model.Proposal.Subtotal.ToString("C")</div>
                <div>Tax: @Model.Proposal.TaxTotal.ToString("C")</div>
                <div>Discounts: @Model.Proposal.DiscountTotal.ToString("C")</div>
                <div class="fw-bold">Grand Total: @Model.Proposal.GrandTotal.ToString("C")</div>
            </div>
        </div>
        <div class="col-md-4">
            <h5>Recent Activity</h5>
            <ul class="list-unstyled small">
                @foreach (var a in Model.AuditEvents)
                {
                    <li><strong>@a.EventType</strong> &middot; @a.CreatedUtc.ToLocalTime(): @a.DataJson</li>
                }
            </ul>
        </div>
    </div>
}
<p class="mt-4"><a asp-page="Edit" asp-route-id="@Model.Proposal?.Id" class="btn btn-outline-secondary">Edit</a> <a asp-page="Index" class="btn btn-secondary">Back</a></p>
